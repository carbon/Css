namespace Carbon.Css.Tests;

public class CssMaskTests
{
    [Fact]
    public void CanPrefix()
    {
        var sheet = StyleSheet.Parse(
            """
            //= support Safari 5+
            //= support Chrome 120+
            div {
              mask-image: url('image.svg');
            }
            """);

        Assert.Equal(
            """
            div {
              -webkit-mask-image: url('image.svg');
              mask-image: url('image.svg');
            }
            """, sheet.ToString(), ignoreLineEndingDifferences: true);
    }

    [Fact]
    public void CanInline()
    {
        var sheet = StyleSheet.Parse(
            """
            //= inline < 4 KiB
            div {
              mask-image: url('image.svg');
            }
            """);


        var rule = (StyleRule)sheet.Children[0];

        var declaration = (CssDeclaration)rule.Children[0];

        Assert.Equal("mask-image", declaration.Name);

        var cssUrl = (CssUrl)declaration.Value;

        Assert.Equal(typeof(CssString), cssUrl.Arguments.GetType());

        var sw = new StringWriter();
        var writer = new CssWriter(sw, context: sheet.Context, resolver: new DummyResolver());

        Assert.Equal(4096, sheet.Context!.MaxInlineSize);

        writer.WriteRoot(sheet);

        Assert.Equal(
          """
          div {
            mask-image: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMTciIHZpZXdCb3g9IjAgMCAyNSAxNyIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4NCjxwYXRoIGQ9Ik0yMy44OTQyIDAuMDA2MDczODdDMjMuOTg0OSAwLjAxODE3MDcgMjQuMDA3MSAwLjAxODE3MDMgMjQuMDk1OCAwLjA0MDM0NzRDMjQuMzI3NyAwLjEwMDgzMSAyNC41Mzk0IDAuMjMxODc0IDI0LjY5ODcgMC40MTEzMDhDMjQuNzg5NCAwLjUxNDEzIDI0Ljg2MiAwLjYzMzA4IDI0LjkxMjQgMC43NjAwOTJDMjQuOTYyNyAwLjg4NzEwNCAyNC45OTMgMS4wMjIxOCAyNC45OTkgMS4xNTkyOEMyNS4wMTcyIDEuNjEwODggMjQuNzc1MyAyLjA0NjM4IDI0LjM4MDEgMi4yNjgxMUMyNC4yNTkxIDIuMzM0NjQgMjQuMTMwMSAyLjM4MTAxIDIzLjk5NSAyLjQwMzE5QzIzLjkwNDMgMi40MTkzMiAyMy44ODIxIDIuNDE3MyAyMy43ODk0IDIuNDIxMzNIMS4yMDkxN0MxLjExODQ1IDIuNDE3MyAxLjA5NDI1IDIuNDE5MzIgMS4wMDU1NSAyLjQwMzE5QzAuNzY3NjQ5IDIuMzYyODcgMC41NDU4ODIgMi4yNDk5NiAwLjM3MjQ3NiAyLjA4NDY0QzAuMjczNjg2IDEuOTg5ODkgMC4xOTEwMjkgMS44NzkgMC4xMzA1NDUgMS43NTYwMkMwLjA2ODA0ODUgMS42MzUwNSAwLjAyNzcyMzcgMS41MDE5OSAwLjAwOTU3Njk0IDEuMzY0OUMtMC4wMzg4MDkzIDAuOTg3ODkgMC4wOTgyODgyIDAuNjAwNzg2IDAuMzcyNDcxIDAuMzM2Njg3QzAuNDQ3MDY2IDAuMjY2MTIzIDAuNTI5NzI3IDAuMjAzNjI3IDAuNjE4NDMzIDAuMTUzMjIzQzAuNzM5NDAxIDAuMDg2NjkgMC44Njg0MzEgMC4wNDAzMjA1IDEuMDA1NTIgMC4wMTgxNDI5QzEuMDk0MjMgMC4wMDIwMTQxMiAxLjExODQyIDAuMDA0MDMxOTMgMS4yMDkxNSAwSDIzLjc4OTRDMjMuODIzNyAwLjAwMjAxNTk2IDIzLjg1NzkgMC4wMDQwMzAyMSAyMy44OTIyIDAuMDA0MDMwMjFMMjMuODk0MiAwLjAwNjA3Mzg3WiIgZmlsbD0iI0I5QzZEQSIvPg0KPHBhdGggZD0iTTIzLjg5MzcgNy4yNjM4NUMyMy45ODQ0IDcuMjc1OTUgMjQuMDA2NiA3LjI3NTk1IDI0LjA5NTMgNy4yOTgxMkMyNC4zMjcyIDcuMzU4NjEgMjQuNTM4OSA3LjQ4OTY1IDI0LjY5ODEgNy42NjkwOUMyNC43ODg5IDcuNzcxOTEgMjQuODYxNCA3Ljg5MDg2IDI0LjkxMTggOC4wMTc4N0MyNS4wODEyIDguNDM3MjEgMjQuOTk2NSA4LjkyOTEzIDI0LjY5ODEgOS4yNjc4NkMyNC42MDc0IDkuMzcwNjggMjQuNTAwNiA5LjQ1NzM3IDI0LjM3OTYgOS41MjU5MkMyNC4yNTg2IDkuNTkyNDUgMjQuMTI5NiA5LjYzODgyIDIzLjk5NDUgOS42NjFDMjMuOTAzOCA5LjY3NzEyIDIzLjg4MTYgOS42NzUxMSAyMy43ODg5IDkuNjc5MTRIMS4yMDg2NUMxLjExNzkzIDkuNjc1MTEgMS4wOTM3MyA5LjY3NzEyIDEuMDA1MDMgOS42NjFDMC44Njk5NDkgOS42Mzg4MiAwLjczODkwNiA5LjU5MjQ1IDAuNjE3OTM4IDkuNTI1OTJDMC4yODczMDEgOS4zNDA0MyAwLjA1NzQ4NDIgOC45OTk3MyAwLjAwOTA3MjIyIDguNjIyNzFDLTAuMDAzMDI0MDcgOC41MTk4OSAtMC4wMDMwMjQwNyA4LjQxNzA3IDAuMDA5MDcyMjIgOC4zMTQyNEMwLjAyNzIxNjkgOC4xNzkxNyAwLjA2NzUzNzYgOC4wNDYxMSAwLjEzMDA0IDcuOTIzMTJDMC4xOTA1MjQgNy44MDAxNCAwLjI3MzE4IDcuNjg5MjYgMC4zNzE5NzEgNy41OTQ1QzAuNTQ1MzU2IDcuNDI5MTggMC43NjcxMjIgNy4zMTYyOCAxLjAwNTA0IDcuMjc1OTZDMS4wOTM3NSA3LjI1OTgzIDEuMTE3OTQgNy4yNjE4NCAxLjIwODY3IDcuMjU3ODFIMjMuNzg4OUMyMy44MjMyIDcuMjU5ODMgMjMuODU3NCA3LjI2MTg0IDIzLjg5MTcgNy4yNjE4NEwyMy44OTM3IDcuMjYzODVaIiBmaWxsPSIjQjlDNkRBIi8+DQo8cGF0aCBkPSJNMjMuODkzOSAxNC41MjE3QzIzLjk4NDYgMTQuNTMzOCAyNC4wMDY4IDE0LjUzMzggMjQuMDk1NSAxNC41NTZDMjQuMzI3MyAxNC42MTY0IDI0LjUzOSAxNC43NDc1IDI0LjY5ODMgMTQuOTI2OUMyNC45OTY3IDE1LjI2NTYgMjUuMDgxNCAxNS43NTc2IDI0LjkxMiAxNi4xNzY5QzI0Ljg2MTYgMTYuMzAzOSAyNC43ODcgMTYuNDIyOSAyNC42OTgzIDE2LjUyNTdDMjQuNjA3NiAxNi42Mjg1IDI0LjUwMDcgMTYuNzE1MiAyNC4zNzk4IDE2Ljc4MzdDMjQuMjU4OCAxNi44NTAzIDI0LjEyOTggMTYuODk2NiAyMy45OTQ3IDE2LjkxODhDMjMuOTA0IDE2LjkzNSAyMy44ODE4IDE2LjkzMjkgMjMuNzg5IDE2LjkzN0gxLjIwODgxQzEuMTE4MDkgMTYuOTMyOSAxLjA5Mzg5IDE2LjkzNSAxLjAwNTE5IDE2LjkxODhDMC43NjcyODcgMTYuODc4NSAwLjU0NTUyIDE2Ljc2NTYgMC4zNzIxMTUgMTYuNjAwM0MwLjI5NzUyIDE2LjUyOTcgMC4yMzMwMDUgMTYuNDQ5MSAwLjE3ODU3IDE2LjM2MDRDLTAuMDIxMDIzOSAxNi4wMzc4IC0wLjA1NTI5MzkgMTUuNjI4NSAwLjA4NTgyODcgMTUuMjc1N0MwLjEzODI0NiAxNS4xNDg3IDAuMjEwODI4IDE1LjAyOTcgMC4yOTk1MzMgMTQuOTI2OUMwLjM5MDI1NyAxNC44MjQxIDAuNDk3MTA5IDE0LjczNzQgMC42MTgwNzcgMTQuNjY4OEMwLjczOTA0NSAxNC42MDIzIDAuODY4MDc1IDE0LjU1NTkgMS4wMDUxNyAxNC41MzM4QzEuMDkzODggMTQuNTE3NiAxLjExODA3IDE0LjUxOTcgMS4yMDg3OSAxNC41MTU2SDIzLjc4OUMyMy44MjMzIDE0LjUxNzYgMjMuODU3NiAxNC41MTk3IDIzLjg5MTggMTQuNTE5N0wyMy44OTM5IDE0LjUyMTdaIiBmaWxsPSIjQjlDNkRBIi8+DQo8L3N2Zz4=");
          }
          """, sw.ToString(), ignoreLineEndingDifferences: true);
    }
}


public sealed class DummyResolver : ICssResolver
{
    public string ScopedPath => "/";

    public bool ShouldInline(string absolutePath)
    {
        return absolutePath.EndsWith(".svg");
    }

    public Stream Open(string absolutePath)
    {
        return new MemoryStream("""
            <svg width="25" height="17" viewBox="0 0 25 17" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M23.8942 0.00607387C23.9849 0.0181707 24.0071 0.0181703 24.0958 0.0403474C24.3277 0.100831 24.5394 0.231874 24.6987 0.411308C24.7894 0.51413 24.862 0.63308 24.9124 0.760092C24.9627 0.887104 24.993 1.02218 24.999 1.15928C25.0172 1.61088 24.7753 2.04638 24.3801 2.26811C24.2591 2.33464 24.1301 2.38101 23.995 2.40319C23.9043 2.41932 23.8821 2.4173 23.7894 2.42133H1.20917C1.11845 2.4173 1.09425 2.41932 1.00555 2.40319C0.767649 2.36287 0.545882 2.24996 0.372476 2.08464C0.273686 1.98989 0.191029 1.879 0.130545 1.75602C0.0680485 1.63505 0.0277237 1.50199 0.00957694 1.3649C-0.0388093 0.98789 0.0982882 0.600786 0.372471 0.336687C0.447066 0.266123 0.529727 0.203627 0.618433 0.153223C0.739401 0.08669 0.868431 0.0403205 1.00552 0.0181429C1.09423 0.00201412 1.11842 0.00403193 1.20915 0H23.7894C23.8237 0.00201596 23.8579 0.00403021 23.8922 0.00403021L23.8942 0.00607387Z" fill="#B9C6DA"/>
            <path d="M23.8937 7.26385C23.9844 7.27595 24.0066 7.27595 24.0953 7.29812C24.3272 7.35861 24.5389 7.48965 24.6981 7.66909C24.7889 7.77191 24.8614 7.89086 24.9118 8.01787C25.0812 8.43721 24.9965 8.92913 24.6981 9.26786C24.6074 9.37068 24.5006 9.45737 24.3796 9.52592C24.2586 9.59245 24.1296 9.63882 23.9945 9.661C23.9038 9.67712 23.8816 9.67511 23.7889 9.67914H1.20865C1.11793 9.67511 1.09373 9.67712 1.00503 9.661C0.869949 9.63882 0.738906 9.59245 0.617938 9.52592C0.287301 9.34043 0.0574842 8.99973 0.00907222 8.62271C-0.00302407 8.51989 -0.00302407 8.41707 0.00907222 8.31424C0.0272169 8.17917 0.0675376 8.04611 0.13004 7.92312C0.190524 7.80014 0.27318 7.68926 0.371971 7.5945C0.545356 7.42918 0.767122 7.31628 1.00504 7.27596C1.09375 7.25983 1.11794 7.26184 1.20867 7.25781H23.7889C23.8232 7.25983 23.8574 7.26184 23.8917 7.26184L23.8937 7.26385Z" fill="#B9C6DA"/>
            <path d="M23.8939 14.5217C23.9846 14.5338 24.0068 14.5338 24.0955 14.556C24.3273 14.6164 24.539 14.7475 24.6983 14.9269C24.9967 15.2656 25.0814 15.7576 24.912 16.1769C24.8616 16.3039 24.787 16.4229 24.6983 16.5257C24.6076 16.6285 24.5007 16.7152 24.3798 16.7837C24.2588 16.8503 24.1298 16.8966 23.9947 16.9188C23.904 16.935 23.8818 16.9329 23.789 16.937H1.20881C1.11809 16.9329 1.09389 16.935 1.00519 16.9188C0.767287 16.8785 0.54552 16.7656 0.372115 16.6003C0.29752 16.5297 0.233005 16.4491 0.17857 16.3604C-0.0210239 16.0378 -0.0552939 15.6285 0.0858287 15.2757C0.138246 15.1487 0.210828 15.0297 0.299533 14.9269C0.390257 14.8241 0.497109 14.7374 0.618077 14.6688C0.739045 14.6023 0.868075 14.5559 1.00517 14.5338C1.09388 14.5176 1.11807 14.5197 1.20879 14.5156H23.789C23.8233 14.5176 23.8576 14.5197 23.8918 14.5197L23.8939 14.5217Z" fill="#B9C6DA"/>
            </svg>
            """u8.ToArray());
    }

}
